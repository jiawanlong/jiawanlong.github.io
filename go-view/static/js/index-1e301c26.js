import{d as te,$ as X,l as x,a1 as G,a9 as ue,cU as $,M as ae,r as o,o as v,c as A,u as l,D as k,w as e,e as t,f as n,q as r,F as J,a8 as Z,B as ie,C as de,j as oe,aa as _e,cO as fe,aG as pe,cM as me,aF as ve,aI as ge,aZ as he,R as K,s as Q,t as z,U as W,be as ye,a6 as we}from"./index-6c47f69d.js";import{c as Y}from"./chartEditStore-bfe1babe.js";import{i as L}from"./icon-da829856.js";import{T as H,D as B}from"./index-3782b823.js";import{u as ne}from"./useTargetData.hook-6aecbd70.js";import{M as be}from"./EditorWorker-2740485c.js";import"./editorWorker-259d4dbf.js";import{g as xe}from"./plugin-07aea9dd.js";import{c as Ce}from"./http-55a69c14.js";import{F as ee}from"./fileTypeEnum-21359a08.js";const P=g=>(ie("data-v-eac7a30e"),g=g(),de(),g),Se=P(()=>r("p",null,[r("span",{class:"func-keyword"},"function"),n("  filter(data, res)  {")],-1)),Fe={class:"go-ml-4"},ke=P(()=>r("p",null,"}",-1)),Te=P(()=>r("span",{class:"func-keyword"},"function",-1)),Re={class:"editor-data-show"},Ee={class:"editor-data-show"},qe={class:"editor-data-show"},De={class:"go-flex-items-center"},Ie=te({__name:"index",setup(g){const{DocumentTextIcon:f}=L.ionicons5,{FilterIcon:q,FilterEditIcon:D}=L.carbon,{targetData:_,chartEditStore:h}=ne();X(_.value.request),X(h.getRequestGlobalConfig);const s=x(!1),p=x(_.value.filter||"return data"),y=x(!1),C=x(""),T=async()=>{try{const u=await Ce(Z(_.value.request),Z(h.getRequestGlobalConfig));if(u){C.value=u;return}window.$message.warning("没有拿到返回值，请检查接口！")}catch(u){console.error(u),window.$message.warning("数据异常，请检查参数！")}},M=G(()=>{try{const u=new Function("data","res",p.value),w=ue(C.value),a=u(w?.data,w);return y.value=!1,$(a)}catch(u){return y.value=!0,`过滤函数错误，日志：${u}`}}),I=()=>{s.value=!0},O=()=>{xe({message:"是否删除过滤器",onPositiveCallback:()=>{_.value.filter=void 0}})},U=()=>{s.value=!1},j=()=>{if(y.value){window.$message.error("过滤函数错误，无法进行保存");return}_.value.filter=p.value,U()};return ae(()=>s.value,u=>{u&&(T(),p.value=_.value.filter||"return data")}),(u,w)=>{const a=o("n-code"),i=o("n-icon"),d=o("n-button"),c=o("n-space"),b=o("n-card"),S=o("n-text"),F=o("n-tag"),R=o("n-divider"),N=o("n-scrollbar"),V=o("n-modal");return v(),A(J,null,[l(_).filter?(v(),k(b,{key:0},{footer:e(()=>[t(c,{justify:"end"},{default:e(()=>[t(d,{type:"primary",tertiary:"",size:"small",onClick:I},{icon:e(()=>[t(i,null,{default:e(()=>[t(l(D))]),_:1})]),default:e(()=>[n(" 编辑 ")]),_:1}),t(d,{tertiary:"",size:"small",onClick:O},{default:e(()=>[n(" 删除 ")]),_:1})]),_:1})]),default:e(()=>[Se,r("div",Fe,[t(a,{code:l(_).filter,language:"typescript"},null,8,["code"])]),ke]),_:1})):(v(),k(d,{key:1,class:"go-ml-3",onClick:I},{icon:e(()=>[t(i,null,{default:e(()=>[t(l(q))]),_:1})]),default:e(()=>[n(" 新增过滤器 ")]),_:1})),t(V,{class:"go-chart-data-monaco-editor",show:s.value,"onUpdate:show":w[1]||(w[1]=E=>s.value=E),"mask-closable":!1,closeOnEsc:!1},{default:e(()=>[t(b,{bordered:!1,role:"dialog",size:"small","aria-modal":"true",style:{width:"1000px",height:"600px"}},{header:e(()=>[t(c,null,{default:e(()=>[t(S,null,{default:e(()=>[n("过滤器函数编辑器")]),_:1})]),_:1})]),"header-extra":e(()=>[]),action:e(()=>[t(c,{justify:"space-between"},{default:e(()=>[r("div",De,[t(F,{bordered:!1,type:"primary"},{icon:e(()=>[t(i,{component:l(f)},null,8,["component"])]),default:e(()=>[n(" 规则 ")]),_:1}),t(S,{class:"go-ml-2",depth:"2"},{default:e(()=>[n("过滤器默认处理接口返回值的「data」字段")]),_:1})]),t(c,null,{default:e(()=>[t(d,{size:"medium",onClick:U},{default:e(()=>[n("取消")]),_:1}),t(d,{size:"medium",type:"primary",onClick:j},{default:e(()=>[n("保存")]),_:1})]),_:1})]),_:1})]),default:e(()=>[t(c,{size:"small",vertical:""},{default:e(()=>[t(c,{justify:"space-between"},{default:e(()=>[r("div",null,[t(c,{vertical:""},{default:e(()=>[t(F,{type:"info"},{default:e(()=>[Te,n("  filter(data, res)  { ")]),_:1}),t(l(be),{modelValue:p.value,"onUpdate:modelValue":w[0]||(w[0]=E=>p.value=E),width:"460px",height:"380px",language:"javascript"},null,8,["modelValue"]),t(F,{type:"info"},{default:e(()=>[n("}")]),_:1})]),_:1})]),t(R,{vertical:"",style:{height:"480px"}}),t(N,{style:{"max-height":"480px"}},{default:e(()=>[t(c,{size:15,vertical:""},{default:e(()=>[r("div",Re,[t(c,null,{default:e(()=>[t(S,{depth:"3"},{default:e(()=>[n("默认过滤数据(data)：")]),_:1}),t(a,{code:l($)(C.value?.data)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})]),r("div",Ee,[t(c,null,{default:e(()=>[t(S,{depth:"3"},{default:e(()=>[n("接口返回数据(res)：")]),_:1}),t(a,{code:l($)(C.value)||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})]),r("div",qe,[t(c,null,{default:e(()=>[t(S,{depth:"3"},{default:e(()=>[n("过滤器结果：")]),_:1}),t(a,{code:M.value||"暂无",language:"json","word-wrap":!0},null,8,["code"])]),_:1})])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["show"])],64)}}});const Ue=oe(Ie,[["__scopeId","data-v-eac7a30e"]]),je=g=>{const f=x();return{uploadFileListRef:f,beforeUpload:({file:h})=>{f.value=[];const s=h.file.type;return s!==ee.JSON&&s!==ee.TXT?(window.$message.warning("仅支持上传 【JSON】 格式文件，请重新上传！"),!1):!0},customRequest:h=>{const{file:s}=h;_e(()=>{s.file?fe(s.file).then(p=>{g.value.option.dataset=pe(p)}):window.$message.error("导入数据失败，请稍后重试或联系管理员！")})},download:()=>{try{window.$message.success("下载中，请耐心等待..."),me(ve(g.value.option.dataset),void 0,"json")}catch{window.$message.error("下载失败，数据错误！")}}}},Ne=te({__name:"index",props:{show:{type:Boolean,required:!1},ajax:{type:Boolean,required:!0}},setup(g){const{targetData:f}=ne(),q=["字段","映射","状态"],{HelpOutlineIcon:D}=L.ionicons5,{DocumentAddIcon:_,DocumentDownloadIcon:h}=L.carbon,s=x(),p=x(),y=x(),C=x(!1),{uploadFileListRef:T,customRequest:M,beforeUpload:I,download:O}=je(f),U=G(()=>f.value.request.requestDataType!==ge.STATIC),j=G(()=>f.value.chartConfig.chartFrame===Y.ECHARTS),u=a=>{let i=B.SUCCESS;for(let d=0;d<s.value.length;d++)if(s.value[d][a]===void 0)return i=B.FAILURE,i;return B.SUCCESS},w=()=>{try{return p.value.map((a,i)=>i===0?{field:"通用标识",mapping:a,result:B.NULL}:{field:`数据项-${i}`,mapping:a,result:u(a)})}catch{return[]}};return ae(()=>f.value?.option?.dataset,a=>{a&&f?.value?.chartConfig?.chartFrame===Y.ECHARTS?(s.value=a,j.value&&(p.value=a.dimensions,y.value=w())):a!=null?(y.value=null,s.value=a):(C.value=!0,s.value="此组件无数据源"),he(a)&&(y.value=null)},{immediate:!0}),(a,i)=>{const d=o("n-badge"),c=o("n-text"),b=o("n-space"),S=o("n-table"),F=o("n-timeline-item"),R=o("n-icon"),N=o("n-button"),V=o("n-upload"),E=o("n-tooltip"),le=o("n-code"),se=o("n-card"),re=o("n-timeline");return v(),k(re,{class:"go-chart-configurations-timeline"},{default:e(()=>[K(t(F,{type:"info",title:l(H).MAPPING},{default:e(()=>[t(S,{striped:""},{default:e(()=>[r("thead",null,[r("tr",null,[(v(),A(J,null,Q(q,m=>r("th",{key:m},z(m),1)),64))])]),r("tbody",null,[(v(!0),A(J,null,Q(y.value,(m,ce)=>(v(),A("tr",{key:ce},[r("td",null,z(m.field),1),r("td",null,z(m.mapping),1),r("td",null,[m.result===0?(v(),k(b,{key:0},{default:e(()=>[t(d,{dot:"",type:"success"}),t(c,null,{default:e(()=>[n("无")]),_:1})]),_:1})):(v(),k(b,{key:1},{default:e(()=>[t(d,{dot:"",type:m.result===1?"success":"error"},null,8,["type"]),t(c,null,{default:e(()=>[n("匹配"+z(m.result===1?"成功":"失败"),1)]),_:2},1024)]),_:2},1024))])]))),128))])]),_:1})]),_:1},8,["title"]),[[W,j.value&&y.value]]),K(t(F,{color:"#97846c",title:l(H).FILTER},{default:e(()=>[t(b,{size:18,vertical:""},{default:e(()=>[t(c,{depth:"3"},{default:e(()=>[n("过滤器默认处理接口返回值的「data」字段")]),_:1}),t(l(Ue))]),_:1})]),_:1},8,["title"]),[[W,U.value]]),t(F,{type:"success",title:l(H).CONTENT},{default:e(()=>[t(b,{vertical:""},{default:e(()=>[t(b,{class:"source-btn-box"},{default:e(()=>[t(V,{"file-list":l(T),"onUpdate:fileList":i[0]||(i[0]=m=>ye(T)?T.value=m:null),"show-file-list":!1,customRequest:l(M),onBeforeUpload:l(I)},{default:e(()=>[t(b,null,{default:e(()=>[g.ajax?we("",!0):(v(),k(N,{key:0,class:"sourceBtn-item",disabled:C.value},{icon:e(()=>[t(R,null,{default:e(()=>[t(l(_))]),_:1})]),default:e(()=>[n(" 导入（json / txt） ")]),_:1},8,["disabled"]))]),_:1})]),_:1},8,["file-list","customRequest","onBeforeUpload"]),r("div",null,[t(N,{class:"sourceBtn-item",disabled:C.value,onClick:l(O)},{icon:e(()=>[t(R,null,{default:e(()=>[t(l(h))]),_:1})]),default:e(()=>[n(" 下载 ")]),_:1},8,["disabled","onClick"]),t(E,{trigger:"hover"},{trigger:e(()=>[t(R,{class:"go-ml-1",size:"21",depth:3},{default:e(()=>[t(l(D))]),_:1})]),default:e(()=>[t(c,{depth:"3"},{default:e(()=>[n("点击【下载】查看完整数据")]),_:1})]),_:1})])]),_:1}),t(se,{size:"small"},{default:e(()=>[t(le,{code:l($)(s.value),language:"json"},null,8,["code"])]),_:1})]),_:1})]),_:1},8,["title"])]),_:1})}}});const Je=oe(Ne,[["__scopeId","data-v-ef52326b"]]);export{Je as C};
